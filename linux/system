# Copyright (c) 2018-2021, Firas Khalil Khana
# Distributed under the terms of the ISC License

# Voyager: Firas Khalil Khana (firasuke) <firasuke@glaucuslinux.org>

prepare() {
  $RSYNC $SRCD/$nom/$nom-$ver/ $SSRC/$nom --delete

  $MKDIR $SBLD/$nom

  cd $SSRC/$nom

  $MAKE \
    mrproper

  radula_behave_patch 1 $nom clear 0104-pci-pme-wakeups
  radula_behave_patch 1 $nom clear 0105-ksm-wakeups
  radula_behave_patch 1 $nom clear 0106-intel_idle-tweak-cpuidle-cstates
  radula_behave_patch 1 $nom clear 0108-smpboot-reuse-timer-calibration
  radula_behave_patch 1 $nom clear 0109-Initialize-ata-before-graphics
  radula_behave_patch 1 $nom clear 0110-give-rdrand-some-credit
  radula_behave_patch 1 $nom clear 0111-ipv4-tcp-allow-the-memory-tuning-for-tcp-to-go-a-lit
  radula_behave_patch 1 $nom clear 0119-use-lfence-instead-of-rep-and-nop
  radula_behave_patch 1 $nom clear 0120-do-accept-in-LIFO-order-for-cache-efficiency
  radula_behave_patch 1 $nom clear 0121-locking-rwsem-spin-faster
  radula_behave_patch 1 $nom clear 0122-ata-libahci-ignore-staggered-spin-up
  radula_behave_patch 1 $nom clear 0123-print-CPU-that-faults
  radula_behave_patch 1 $nom clear 0127-nvme-workaround

  radula_behave_patch 0 $nom glaucus 0001-libarchive-bsdtar-compatibility
}

configure() {
  $MAKE \
    O=$SBLD/$nom \
    ARCH=$LARCH \
    ${LCARCH}defconfig
}

build() {
  $MAKE \
    O=$SBLD/$nom \
    ARCH=$LARCH
}

check() {
  :
}

install() {
  $MAKE \
    O=$SBLD/$nom \
    ARCH=$LARCH \
    INSTALL_MOD_PATH=$SCER/$nom/sac/usr \
    modules_install

  $MKDIR $SCER/$nom/sac/boot

  $RSYNC $SBLD/$nom/$LIARCH $SCER/$nom/sac/boot/vmlinuz
  $RSYNC $SBLD/$nom/System.map $SCER/$nom/sac/boot
}
